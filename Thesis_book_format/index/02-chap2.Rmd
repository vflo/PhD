\chapter[Bias and uncertainty in sap flow methods]{A synthesis of bias and uncertainty in sap flow methods}
\setlength{\parindent}{0pt}
Victor Flo, Jordi Martinez-Vilalta, Kathy Steppe, Bernhard Schuldt, Rafael Poyatos
\newpage
\setlength{\parindent}{30pt}


\section*{Abstract}
Sap flow measurements with thermometric methods are widely used to measure transpiration in plants. Different method families exist depending on how they apply heat and track sapwood temperature (heat pulse, heat dissipation, heat field deformation or heat balance). These methods have been calibrated for many species, but a global assessment of their uncertainty and reliability has not yet been conducted. Here we perform a meta-analysis of 290 individual calibration experiments assembled from the literature to assess calibration performance and how this varies across methods, experimental conditions and wood properties (density and porosity types). We used different metrics to characterize mean accuracy (closeness of the measurements to the true, reference value), proportional bias (resulting from an effect of measured flow on the magnitude of the error), linearity in the relationship between measurements and reference values, and precision (reproducibility and repeatability). We found a large intra- and inter-method variability in calibration performance, with a low proportion of this variability explained by species. Calibration performance was best when using stem segments. We did not find evidence of strong effects of wood density or porosity type in calibration performance. Dissipation methods showed lower accuracy and higher proportional bias than the other methods but they showed relatively high linearity and precision. Pulse methods also showed significant proportional bias, driven by their overestimation of low flows. These results suggest that Dissipation methods may be more appropriate to assess relative sap flow (e.g., treatment effects within a study) and Pulse methods may be more suitable to quantify absolute flows. Nevertheless, all sap flow methods showed high precision, allowing potential correction of the measurements when a study-specific calibration is performed. Our understanding of how sap flow methods perform across species would be greatly improved if experimental conditions and wood properties, including changes in wood moisture, were better reported.\par

\newpage

##Introduction
Quantifying transpiration of vegetation is of major importance for hydrological, ecological, and agricultural sciences, since it represents 60-80% of the water that returns from the land surface to the atmosphere (@Jasechko2013; @Schlesinger2014; @Wei2017). The study of transpiration and its environmental sensitivity is essential to understand vegetation water cycling (@Frank2015; @Konings2017; @Novick2016) and to forecast changes in vegetation functioning and composition under climate change (@Allen2015). Addressing these questions requires non-destructive measurements of whole-plant transpiration at multiple timescales (@Wullschleger1998). Thermal methods of sap flow measurement show a number of advantages over other methods such as those based on isotopes tracing or leaf gas exchange  (@Smith1995), and have become the most widely used approach to estimate tree-level transpiration (@Poyatos2016) (Fig. A1). When compared against independent estimates of evapotranspiration components, sap flow methods have provided reasonable qualitative and quantitative results (@Diawara1991; @Hogg1997; @Kool2014; @Schlesinger2014; @Zhang2014; but see @Wilson2001; @Oishi2008; @Shimizu2015). However, sap flow measurements may be subject to various potential sources of error. Some of these errors are related to scaling sap flow variability both within trees and from tree to stand level (@Hatton1995; @Hernandez-Santana2015; @Mitchell2009), while others are related to intrinsic limitations of the methods or to how these methods are applied (see @Vandegehuchte2013). Although these biases have been studied, they have not yet been quantified globally and there is no conclusive assessment of how they differ across methods or species characteristics, including wood properties (@Poyatos2016).\par

Sap flow methods (@Vandegehuchte2013) can measure sap flow rate (SF, g $\text{h}^{-1}$ or equivalent units) or sap flux density (i.e., sap flow rate per unit sapwood area, SFD, $\text{cm}^3$ $\text{cm}^{-2}$ $\text{h}^{-1}$ or equivalent units) in a plant’s conductive tissue and can be classified in four families depending on how they heat the sapwood and how they measure sapwood temperatures: (1) the Dissipation family, including thermal dissipation (TD; @Granier1985) and transient thermal dissipation (@Do2002, TTD @Do2002b) methods, which measure the dissipation of heat from a heated probe inserted in the sapwood with reference to a reference, non-heated probe; (2) the Pulse family, including the compensation heat pulse (CHP; @Swanson1981), heat ratio (HR; @Burgess2001), T-max (@Cohen1981), calibrated average gradient (CAG; @Testi2009), sapflow+ (SF+; @Vandegehuchte2012a; @Vandegehuchte2012b), single probe heat pulse (SPHP; @López-Bernal2017) and dual heat pulse methods (Dual; @Pearsall2014), which all apply heat in pulses and track sapwood temperature changes caused by thermal convection and conduction; (3) the Field family, including the heat field deformation (HFD; @Nadezhdina2018; @Nadezhdina1998) and its derivatives, which measure the shape changes of a continuous heat field in the sapwood, using axial and tangential probes; and (4) the Balance family, represented by stem heat balance (SHB; @Daum1967; @Sakuratani1981; @Vieweg1960) and trunk heat balance (THB; @Cermak2004; @cermak1973) methods, which measure the energy balance across a heated wood section. This latter family is the only one directly measuring sap flow rate, while all the others measure sap flux density.\par

Methodological errors in sap flux density measurements may be caused by wounding following probe insertion into the sapwood (except for the miniaturized non-invasive ones; see (@Clearwater2009; @Hanssens2013; @Schreel2018), biological variation in wood parameters and diverse raw data processing approaches (@Oishi2016; @Peters2018; @Vergeynst2014). Wounding affects heat and water transport and thus may disrupt sap flow measurements (@Barrett1995; @Burgess2001; @Green2009; @Green2003; @Green1988; @Steppe2015), especially during long-term installations (@Maranon-jimenez2018; @Wiedemann2013). While wound corrections have been available for a long time for some Pulse family methods (@Green2003; @Swanson1981), they have only become recently available for other methods such as TD (@Wiedemann2016). Sap flux density methods are also affected by changes in radial patterns, which are not constant over time, so these methods have to measure the entire sapwood depth by sufficiently large probes, or by individual measurement points at different depths (@Hatton1990). Although some methods have a more solid theoretical background based on the physics of thermal transport (Pulse and Balance methods), all of them rely on a certain degree of empiricism, which may introduce errors caused by biological variability and/or variation in signal processing approaches: species-specific empirical calibrations in Dissipation methods (@Fuchs2017), zero-flow determination or baselining (@Lu2004; @Peters2018), and different parameterization of thermal sapwood properties in Pulse and Field methods (@Chen2012). These thermal sapwood parameters could change over time, introducing further errors in the measurements (e.g. changes in stem water content; @Vergeynst2014). Within the Balance family, those using external heating do not suffer from potential errors due to wounding, but they all require zero-flow determination (@Smith1996). Balance methods have often been considered to better integrate spatial variability in sap flow (@Cermak2004), but whether they perform generally better than sap flux density methods remains unknown.\par

Other errors in sap flow measurement may result from not accounting properly for method-specific assumptions. For many sap flow methods, natural temperature gradients (NTG) need to be minimized and/or accounted for to obtain unbiased estimates of sap flow (@Reyes-Acosta2012; @Vandegehuchte2015). Incorrect sensor geometry (misalignment) affects the accuracy of the measurements (@Burgess2001; @Cabibel1991; @Ren2017; @Swanson1983; @Swanson1981). Other application errors, such as those arising from the incomplete contact of TD probes with the sapwood (@Clearwater1999) are difficult to prevent, though they can be reasonably corrected a posteriori (e.g. Clearwater correction; @Hultine2010; @Paudel2013). Despite that these application errors have been well described in individual studies, a general quantification of these errors for the most employed sap flow methods is currently lacking.\par

Comparisons of sap flow measurements with respect to a reference method (hereafter, for simplicity, ‘sap flow calibrations’) are usually aimed at obtaining species-specific calibrations (@Vandegehuchte2013) to assess different parameterizations of wood thermal properties (@Vandegehuchte2012) or to validate empirical corrections (e.g., wounding, NTG, changes in water content, misalignment; @Burgess2001; @Vergeynst2014). Although few studies calibrate multiple sap flow methods for different species (@Fuchs2017), collectively these calibration studies have shown the inherent limitations of different sap flow methods to deal with low (@Green2003) or high flows (@Green2009). Variability and quality in calibration performance may also be related to specific wood properties such as wood density (@Suleiman1999; @Wullschleger2011), especially given the fact that wood density enters the calculation of sap flux density for some methods (@Vandegehuchte2012) and co-varies with wood moisture content (@Looker2016). Because thermal properties of wood are dependent on both, i.e. wood density and moisture content (@MacLean1941), they might additionally be influenced by wood anatomical traits such as wood porosity type, i.e. coniferous, diffuse-porous or ring-porous wood. In conifers, however, no clear effects of wood density on calibration variability have been reported (@Peters2018). Therefore, a quantitative synthesis of sap flow calibrations, accounting for variation caused by different flow ranges and wood properties is needed to generalize and understand the patterns observed in individual calibration studies.\par

Here, we compile a global database of published sap flow calibrations to quantify the measurement errors associated with different sap flow methods and to assess the factors underlying variability across methods. In assessing calibrations, we distinguished between mean systematic bias (accuracy), a measure of the average degree of closeness of the measurements to the value obtained with a reference method; proportional bias, which occurs when the magnitude of the error is a function of the flow; linearity in the relationship between measurements and values obtained with a reference method; and precision, a measure of reproducibility and repeatability. Our main objective is to assess the differences in accuracy, proportional bias, linearity and precision among methodological families and individual sap flow methods; in addition, we will determine whether calibration performance across methods is associated with species wood traits (wood density and porosity type).\par


##Material and methods
### Sap flow calibration datasets

We retrieved sap flow calibration studies of the seven most common methods (CHP, T-max, HR, HFD, SHB, TD, TTD) applied on trees, palms or lianas, using standard database searching tools (i.e. Scopus, Web of Science and Google Scholar). The search was conducted in June 2017 applying the following keywords: sap fl\*, sap flux density, calibration, potomet\*, gravimet\*, thermal dissipation, heat pulse, heat balance, heat field deformation, compensation heat pulse, T-max, and their combinations. Other sources of data were obtained from the references of previously collected studies. For each calibration experiment, we obtained paired observations of sap flow, measured with a thermal method and with an independent reference method (typically gravimetric or volumetric). Data was digitized from published figures (using GetData Graph Digitalizer version 2.26.0.20). We asked the authors to supply the raw data when these were unavailable from the original publication. We obtained data from 60 studies (see Table A1) reporting 374 individual calibration experiments performed on 81 different shrub and trees species (10,186 data points in total). In the analysis, we only used calibrations that were properly applied according to our definition below (i.e. 290 calibrations out of 374) to restrict the variability to the intrinsic characteristics of the methods.\par

We always considered sap flow observations obtained with the original parameters of the methods (e.g. Granier’s original calibration for TD), without applying the coefficients derived from the calibrations themselves. Some calibrations with TD gave measured K values (i.e. sap flow index, calculated from raw sapwood temperature differences) instead of measured SFD and, in these cases, K values were transformed to SFD using Granier’s original equation and calibration coefficients (Eq. 2.1, a = 42.84 $\text{cm}^3\; \text{cm}^{-2}\; \text{h}^{-1}$, b = 1.231)  (@Granier1985).

\begin{equation}
SFD = a\times K^b
\end{equation}

For each calibration, we recorded the type of calibration material: whole plants, whole plants without roots or cut stem segments. We also assessed whether the sap flow method was properly applied using the best available protocol specified for each method. We considered a proper application of Dissipation methods when the probe was shorter than the sapwood depth and radial profile correction was applied, when the probe was approximately equal to the sapwood depth, or when the probe was longer than the sapwood depth and this effect was corrected for following Clearwater et al. [-@Clearwater1999]. To test whether our results could have been affected by this correction, we performed a preliminary analysis with the same structure as the main statistical model (cf. section 2.3.3) comparing TD calibrations with or without the Clearwater correction and we did not find significant effects on any of the metrics of calibration performance (cf. section 2.3.2) (data not shown). We considered a proper application of Pulse methods when wound correction was applied and either the probe had multiple measuring points along the sapwood or a radial sap flow profile correction was applied. We always considered Balance methods and Field methods as properly applied, because they always integrate (or account for) spatial variability of sap flow.\par

Finally, to analyze the influence of wood traits on calibration performance we used wood density, defined as fresh volume over oven-dry mass, and wood porosity type of the species employed in each study. Wood density was supplied in only a few studies (7 species ~ 80 calibration experiments ~ 4 studies). Assuming that for wood density between-species variability is typically larger than within-species variability (Siefert et al., 2015; Vilà-Cabrera et al., 2015), we retrieved wood density of each species from the TRY database (Kattge et al., 2011). Wood densities of Carica papaya, Phoenix dactylifera and Vitis vinifera were obtained from Kempe [-@Kempe2014], Fathi [-@Fathi2014] and Castelan-Estrada [-@Castelan-Estrada2002], respectively, as they were not recorded in TRY. When wood density could not be found for a given species, we used the phylogenetically nearest species of the same genus if available in TRY (10 of 81 species; e.g. Citrus sinensis for Citrus reticulata). We could not estimate wood density for three taxa (Humulus lupulus, Musa sp. and Siagrus romanzoffiana). A correlation between calibration-specific and species-level wood density extracted from the TRY database (r = 0.78, P < 0.01, n = 12 calibrations, 6 species) indicates that species-level wood density values indeed are applicable for our purpose, but the results should be interpreted with caution. Finally, wood porosity was obtained from the InsideWood database (@insidewood; @Wheeler2011), using four categories: ring-porous, diffuse-porous (i.e. diffuse and semi-diffuse porous), conifer and monocots.\par

### Calibration assessment

Although the reference methods always provide an estimate of sap flow through plants or stem segments, sap flow measurements can be reported as SF or SFD. It was not possible for us to interconvert between SF and SFD in all cases because sapwood areas were not always reported. This precluded a joint analysis of all the paired observations in the same linear model because units differ between SF and SFD. To overcome this problem and to maximize the amount of data considered in the analyses, we first evaluated calibration performance using four complementary dimensionless metrics at the calibration level, which allowed us to analyze globally all calibrations regardless of the magnitude they reported (SF or SFD). In a second stage, we quantified the variability in the absolute errors in sap flow measurements across methods and flow ranges separately for SF and SFD methods. We did not expect differences between calibrations reported with SF or SFD because the inter-conversion between them only involves a scalar transformation. In addition, preliminary analyses confirmed that there was no significant difference between SF and SFD for any of the calibration performance metrics reported in this study (Table A2).\par

For the global analysis, the following metrics were calculated for each calibration (SF and SFD): the average ln ratio (Ln-Ratio) between measured and reference values as a measure of overall accuracy; the slope of the relationship between measured and reference sap flow to characterize proportional bias (Slope); the slope of the ln-ln relationship between measured and reference sap flow as a measure of linearity (Slope (ln-ln)); and Z Pearson’s Correlation to describe precision (Z-Cor) (Fig. 2.1). To calculate these metrics, we filtered out data points with measured or reference flows less or equal to 0. All calibration metrics and subsequent statistical models were performed in R 3.4.2 (@RCoreTeam2017). For model-based metrics, we always checked residuals to ensure they satisfied normality and homoscedasticity assumptions.
Accuracy was evaluated as the mean of the natural logarithm of the ratio between paired measurements (j) of each calibration (i):

\begin{equation}
Ln-Ratio_i = \frac{\sum_{j=1}^{n} ln(\frac{measured_j}{reference_j})_i}{n_i}
\end{equation}

where $measured_j$ and $reference_j$ are the paired measurements of sensor-estimated and reference flow, respectively, and n the number of paired measurements for each calibration i (see Fig. 2.1). The Ln-Ratio varies between $-\infty$ and $+\infty$, and equals 0 for a calibration with perfect mean accuracy (i.e. lack of systematic bias). We also expressed this metric as the exponential of Ln-ratio minus one multiplied by 100, as an indicator of accuracy deviation (in %).\par

The slope of the linear relationship (Eq. 2.3) describes how the magnitude of the error changes (linearly) as a function of the reference flow. The slope of the ln-ln relationship (Eq. 2.4) captures the linearity between the measured and the reference flow. Both slope estimates were calculated for each calibration using a simple linear regression (lm - package stats):

\begin{equation}
measured_{ij} \sim \beta_{0i}+\beta_{1i}\;reference_{ij}+e_{ij}
\end{equation}   

\begin{equation}
ln(measured_{ij}) \sim \beta^{\prime}_{0i}+\beta^{\prime}_{1i}\;ln(reference_{ij}) +e_{ij}
\end{equation} 

where $\beta_{0i}$ and $\beta'_{0i}$ are the intercepts and $\beta_{1i}$ and $\beta'_{1i}$ are the slopes for each calibration ($i$), and $j$ indicates individual calibration points. Hereafter, we will refer to $\beta_{1i}$  as $Slope$ and to $\beta'_{1i}$ as $Slope (ln-ln)$; slope values equal to 1 characterize measurements without proportional bias (Eq. 2.3) and with high linearity (Eq. 2.4), respectively.\par

We used Pearson’s correlation coefficients r between measured and reference flow of each calibration experiment ($i$) as a metric to describe the precision of the methods. The distribution of the resulting variable was skewed due to the large amount of correlation coefficients close to 1, so we used Fisher’s Z transformation (Eq. 2.5) to achieve normality:
\begin{equation}
Z-Cor_i = \frac{1}{2}ln(\frac{1+r_i}{1-r_i})
\end{equation}

Low values of $Z-Cor$ correspond to low r correlations, and high values of $Z-Cor$ correspond to high $r$ correlations and thus high precision (data set range $r$ = [0.0491 – 0.9999]; $r$= 0.0491 ~ $z$ = 0.0491; $r$ = 0.9999 ~ $z$ = 5.1594).\par

```{r ch2fig1, echo=FALSE,  out.width = '55%',fig.pos="hbt!", fig.align="center", fig.scap="Graphical representation of the calibration performance metrics.", fig.cap="Graphical representation of the calibration performance metrics used in the analyses. Each panel presents the same simulated calibration points, representing plausible data. Blue dots represent an accurate, unbiased, linear and precise calibration, while red dots represent an inaccurate, biased, non-linear and imprecise calibration."}
knitr::include_graphics(path = "figure/CH2/PLOTMETRICS.png")
```

In the analysis of the absolute errors of sap flow measurements, we calculated the Normalized Root Mean Square Error (NRMSE) for each calibration ($i$) (Eq. 2.6), separately for SFD and SF methods, in order to obtain the percentage of absolute error at the mean range of each calibration ($i$). 

\begin{equation}
NRMSE_i = \frac{(\sqrt \frac{\sum_{j=1}^{n} (measured_j-reference_j)^2}{n})_i\times 100}{range\;mean_i}
\end{equation}

Subsequently, from the NRMSE and the mean range of each calibration, we fitted a linear model for each method allowing to quantify the absolute error (RMSE) at a given sap flow and also to obtain a RMSE at a reference flow (cf. section 2.3).\par

### Statistical analyses

All the analyses were performed using linear mixed-effects models (LMM) with the package lmer (@Bates2015). Least-square means were estimated with package lsmeans (@Lenth2016) and used to summarise the effects of fixed factors and to test contrasts among predictions. In all models, we used the variables Study and Species as partially crossed random effects (@Schielzeth2013), as we are interested in taking into account the variability associated with study and species, and also to analyze within- and between-group variability. We used Study as we expect experimental variability between researchers or laboratories, and Species because calibration performance has been reported to vary across species (@Fuchs2017; @Smith1996; @Steppe2015). For each model, $R^2_m$ and $R^2_c$ (marginal and conditional coefficients of determination, respectively) based on Nakagawa & Schielzeth [-@Nakagawa2013] were calculated using the function r.squaredGLMM of the package MuMIn (@Barton2017) in R. Intraclass Correlation Coefficients (ICC) were also calculated for the random factors to quantify the proportion of variance within and among groups (low ICC implies high intra-group variability).\par

In a first analysis, we were interested in assessing the differences in calibration metrics (Ln-Ratio, Slope, Slope (ln-ln), Z-Cor) between different families of methods (Family: Pulse, Dissipation, Balance and Field methods), because methods within a family share similar physical principles. We also analyzed differences between individual methods with a sufficient sample size (Method: CHP, T-max, HR, HFD, SHB, TD, TTD). As the calibration material determines, to a large extent, the experimental conditions, we also included this variable in our models (Material: whole plants, whole plants without roots or cut stem segments). For the analysis of absolute errors of sap flow measurements, we modelled NRMSE as a function of Method and the Mean Range of SFD (or SF for Balance methods) in each calibration, as well as their interaction. We used the same random structure as in previous models.\par 

Finally, we assessed how each calibration metric depended on Wood Density and Wood Porosity. A first model included all methods available, with Method interacting with Wood Density as predictors. In order to test Wood Porosity effects, we fitted separate models for CHP and TD calibrations, as these two methods were the only ones that had enough data (> 5 calibrations) for more than one type of porosity. Separate models were needed because not all wood porosity types were represented for all methods. In both models we also included Material as an explanatory cofactor, and the same random structure as in the first analysis explained above.\par

##Results
Most of the published calibrations were performed with Pulse and Dissipation methods (Table 2.1). In particular, 61% of the total number of the properly applied calibrations were conducted using TD or CHP, followed by HFD and HR. SHB, T-max and TTD methods were less represented, with 8 – 14 calibrations each. The metrics extracted from the raw calibrations were highly variable within methods (Fig. 2.2). Calibration metrics often followed a quasi-normal distribution, but in most cases distributions were truncated or skewed, particularly for methods with fewer calibrations (Fig. 2.2).\par


```{r Ch1T1, echo=FALSE,message=FALSE,fig.pos="hbt!",fig.align="center"}
readr::read_delim("data/Ch2/Ch2T1.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)->Ch2T1
library(tidyverse)
library(knitr)
library(kableExtra)
knitr::kable(Ch2T1, "latex", booktabs = T,escape = FALSE,align=c('l',rep("c",10)),linesep = "", caption.short = "Analysis summary for the different methods and families.", caption = "Analysis summary for the different methods and families of methods obtained from the LMM models (least-squares means). We provide the four dimensionless metrics: the Ln-ratio as a measure of accuracy, the accuracy deviation calculated as the exponential of the Ln-ratio minus one multiplied by 100, the Slope to characterize the proportional bias, the slope of the ln-ln-relationship, Slope (ln-ln), as a measure of linearity, and Z Pearson’s correlation (Z-Cor) to describe overall precision; n: number of calibrations; studies: number of studies of each method; species: number of different species; r is the correlation calculated as the tanh of Z-Cor.") %>% 
  kableExtra::kable_styling(font_size = 6,latex_options = "scale_down",position = 'left') %>% column_spec(7, width = "5.5em")
   # kableExtra::kable_styling(latex_options = "HOLD_position")#%>%
   # add_footnote("Statistical significant levels: \".\" p<0.1 ; \"*\" p<0.05; \"**\" p<0.01; \"***\" p<0.001.",notation = "none")
```

```{r ch2fig2, echo=FALSE,  out.width = '55%',fig.pos="hbt!", fig.align="center", fig.scap = "Distribution of the calibration performance metrics for each method.", fig.cap="Distribution of the calibration performance metrics for each method. Dots represents the value of each individual calibration metric. Crosses represent the average of the metric for each method. Horizontal, dashed lines specify reference, perfect calibration values for a given metric."}
knitr::include_graphics(path = "figure/CH2/Distribution-metrics-orderedV4.png")
```


### Calibration performance compared among methods and families of methods

The average accuracy deviation across sap flow methods (properly applied) ranged between 14.2% for CHP and -40.5% for TD (Table 2.1). There were significant differences in accuracy (Ln-Ratio) among families of methods and for methods but not for calibration materials (Fig. 2.3). The Dissipation family in general and the TD and TTD methods in particular were the only cases for which the Ln-Ratio was significantly different from 0 (p<0.001) (Fig. 2.3), indicating systematic bias (underestimation).\par

Proportional bias, estimated by Slope, varied among methods and families of methods (p<0.01). Among families, Dissipation methods showed a significantly smaller Slope than Pulse and Field methods (Fig. 2.3(a)), which was largely driven by the low value of TD (Fig. 2.3(b)). Also, both Pulse and Dissipation families had slopes significantly different from 1 (p<0.01 and p<0.001, respectively), but only the slope of the TD method was significantly lower than 1 (p<0.001) (Fig. 2.3). As for the effects of calibration material, calibrations made with whole plants had a significant proportional bias (Slope < 1, p<0.001) (Fig. 2.3).

```{r ch2fig3, echo=FALSE,  out.width = '100%', fig.pos="p", fig.align="center", fig.scap = "Predictions of the LMM models of the four calibration metrics.", fig.cap="Predictions of the LMM models calculated from least-squares means of the four calibration metrics (Ln-Ratio as a proxy for mean accuracy, Slope for proportional bias, Slope (ln-ln) for linearity and Z-Cor for precision) for (a) different families of sap flow methods or for (b) different sap flow methods and for different calibration materials (Segment: stem segment; Whole plant: whole plant on a container or lysimeter; No-roots: whole plant without roots). 95\\% confidence intervals of the estimates are also shown. Different letters indicate significant differences between factors levels evaluated with Tukey\'s test. Horizontal, dotted lines indicate reference, perfect calibration values for a given metric. Asterisks (*) indicate significant departure from those reference values."}

knitr::include_graphics(path = "figure/CH2/FAMILYMETHODS.png")
```

Calibration linearity, as denoted by Slope (ln-ln), varied across methods and families of methods (p<0.001). We observed higher values of Slope (ln-ln) for the TD method compared to CHP, T-max, HR and HFD. Consistently, the Dissipation family in general also had a higher Slope (ln-ln) than the Pulse and Field families (Fig. 2.3). CHP, T-max and HFD (and Pulse and Field methods in general) had a Slope (ln-ln) significantly lower than 1 (Table 2.1 and Fig. 2.3(b)), indicating a convex relationship between reference and measured flow. Calibrations performed with whole plants suffered from lack of linearity, indicated by Slope (ln-ln) significantly lower than 1 (Fig. 2.3).\par

Precision (Z-Cor) was explained by both method and calibration material. The HFD method (and Field methods in general) provided significantly higher precision than either Pulse or Dissipation methods (particularly CHP, TD and TTD) (Table 2.1 and Fig. 2.3(b)). Calibrations performed on stem segments provided higher precision than those conducted on whole plants (with or without roots) (Fig. 2.3).\par

In all the previous models, little variability was explained by species ($\tau_{00}$, species), relative to the higher variability associated to Study, particularly for the Ln-Ratio and Z-Cor models ($\tau_{00}$, study, Table A3). This is consistent with the low ICC values observed for the species factor, indicating that there is more variability within than among species (Table A3).\par

In addition, the analysis of the normalized absolute error for the different methods showed that NRMSE decreased linearly with increasing measured sap flow in CHP, HFD and TTD methods and increased for T-max, SHB and TD (Table 2.2 and Fig. A2).  For HR the increase in NRMSE with measured sap flow was not significant. For all the methods that measure SFD, the absolute error at a typical flow of 25 $\text{cm}^3$ $\text{cm}^{-2}$ $\text{h}^{-1}$ ranged between 6.3 $\text{cm}^3$ $\text{cm}^{-2}$ $\text{h}^{-1}$ for CHP and 10.7 $\text{cm}^3$ $\text{cm}^{-2}$ $\text{h}^{-1}$ for the TTD method (Table 2.2).\par


```{r Ch2T2, echo=FALSE,message=FALSE,fig.pos="hbt!"}
readr::read_delim("data/Ch2/Ch2T2.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)->Ch2T2
library(tidyverse)
library(knitr)
library(kableExtra)

Ch2T2 <- Ch2T2 %>% mutate(`$\\beta_0$\\; \\%` = gsub("\\","",x=`$\\beta_0$\\; \\%`,fixed=TRUE),
                          `$\\beta_1$` = gsub("\\","",x=`$\\beta_1$`,fixed=TRUE))

knitr::kable(Ch2T2, "latex", booktabs = T,escape = FALSE,align='c',linesep = "", caption.short = "Error analysis of different sap flow methods.", caption = "Error analysis of different sap flow methods. The normalized root mean square error (NRMSE) is modelled as a function of method and the mean flow range for each calibration (and their interaction) using a LMM model with the same random structure as the main models (cf. section 2.3). $\\beta_0$ and $\\beta_1$ are the corresponding intercepts and slopes, respectively ($\\beta_0$ expressed as \\% NRMSE; $\\beta_1$ expressed as \\% NRMSE per change in $\text{cm}^3$ $\\text{cm}^{-2}$ $\\text{h}^{-1}$ for SFD or as \\% NRMSE per change in $\\text{cm}^3$ $\\text{h}^{-1}$ for SF). This linear model, was also used to calculate a reference NRMSE at a sap flux equivalent to the percentile 50 of the range of the data in the calibrations (SFD: 25 $\\text{cm}^3$ $\\text{cm}^{-2}$ $\\text{h}^{-1}$; SF: 1300 $\\text{cm}^3$ $\\text{h}^{-1}$). The expected NRMSE and RMSE (in brackets, in $\\text{cm}^3$ $\\text{cm}^{-2}$ $\\text{h}^{-1}$, except for SHB that is in $\\text{cm}^3$ $\\text{h}^{-1}$) at a typical flow are also given.") %>% 
  kableExtra::kable_styling(font_size = 10, position = 'center') %>% 
  add_header_above(c(" ", "NRMSE" = 3)) %>% 
  # kableExtra::kable_styling(latex_options = "HOLD_position")#%>%
  add_footnote("Statistical significant levels: \".\" p<0.1 ; \"*\" p<0.05; \"**\" p<0.01; \"***\" p<0.001.",notation = "none")
```



### Influence of wood traits

We did not find any significant influence of wood density on accuracy and linearity metrics (Fig. 2.4). Nonetheless, we observed a negative effect of wood density on proportional bias of HFD and TD calibrations (p<0.05 and p<0.1, respectively). In addition, a significant positive effect of wood density on the precision of HFD measurements was observed (p<0.001), indicating that the higher the wood density, the higher the precision (Fig. 2.4).\par

We did not find any significant difference among wood porosity types in calibration metrics for studies using the TD or CHP methods. Nevertheless, the non-linearity (Slope (ln-ln) < 1) observed in general for the CHP method (Fig. 2.3(b)) was only significant for species with diffuse-porous wood, not for conifer species (Table 2.3).\par

```{r ch2fig4, echo=FALSE,  out.width = '55%', fig.pos="hbt!", fig.align="center", fig.scap = "Relationship between the four calibration performance and wood density, for different sap flow methods.", fig.cap="Relationship between the four calibration performance metrics (Ln-Ratio as a proxy for accuracy, Slope for proportional bias, Slope (ln-ln) for linearity, and Z-Cor for precision) and wood density, for different sap flow methods. Horizontal, dashed red lines indicate reference, perfect calibration values for a given metric. Regression lines are shown for significant effects only, and the corresponding level of significance (p-value: <0.1: (.), <0.05: (*), < 0.01: (**), < 0.001: (***)) is also reported "}

knitr::include_graphics(path = "figure/CH2/DENSITY.png")
```

```{r Ch2T3, echo=FALSE,message=FALSE,fig.pos="hbt!",fig.align="center"}
readr::read_delim("data/Ch2/Ch2T3.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)->Ch2T3
library(tidyverse)
library(knitr)
library(kableExtra)
knitr::kable(Ch2T3, "latex", booktabs = T,escape = FALSE,align='c',linesep = "", caption.short = "Least-squares means and 95\\% CI calculated from the LMM models testing the effect of different wood porosity types", caption = "Least-squares means and 95\\% CI calculated from the LMM models testing the effect of different wood porosity types (Wood porosity) on sap flow calibration performance metrics (Ln-Ratio as a proxy for accuracy, Slope for proportional bias, Slope (ln-ln) for linearity, and Z-Cor for precision) for CHP and TD methods. No differences were detected among wood anatomies. Significance levels indicate departure from an ideal calibration (Ln-Ratio = 0; Slope = 1; Slope (ln-ln) = 1)") %>% 
  kableExtra::kable_styling(font_size = 6,latex_options = "scale_down",position = 'center') %>% column_spec(2, width = "1.5cm") %>%
  # collapse_rows(columns = 1, valign = "middle")%>%
  add_header_above(c(" "," "," ", "Accuracy" = 1, "Proportional bias" = 1,"Linearity" = 1, "Precision" = 1)) %>% 
  # kableExtra::kable_styling(latex_options = "HOLD_position")#%>%
  add_footnote("Statistical significant levels: \".\" p<0.1 ; \"*\" p<0.05; \"**\" p<0.01; \"***\" p<0.001.",notation = "none")
```

##Discussion
Our results show a large variability in the quality of sap flow calibrations, even within the same sap flow method (Fig. 2.2), highlighting the large variability among and even within studies. This implies that, even if methods are properly applied (as defined in section 2.1), sap flow measurements can still produce biased estimates of water transport rates in plants, and these errors will need to be considered in quantitative analyses based on this type of measurements. On average, however, all sap flow methods assessed here produced results that may be acceptable for qualitative use in most applications, as shown by the typical high correlation between measured and reference values (r > 0.89 for all methods and method families, Table 2.1). For quantitative use, no method appears to be suitable for all experimental contexts, and researchers need to consider both the inherent limitations of the methods and the need to perform study-specific calibrations (see Implications and recommendations, Table 2.4).\par

###Sap flow measurement errors across methods and methodological families

A relatively small part of the total variability in the quality of calibrations is related to methods and families of methods and, to a lesser extent, to the calibration material (fixed effects explain 8 – 28% of the variability in calibration metrics; see $R^2_m$ values in Table A3). Despite the high variability within methods, we detected significant differences between methods. Dissipation methods were the only methods for which accuracy was significantly lower than expected for an ideal calibration. This is consistent with previous reports (@Braun1999; @Bush2010; @Caterina2014; @Chan2015; @DeOliveiraReis2006; @Fuchs2017; @Lu1998; @McCulloh2007; @Montague2006; @Rubilar2017; @Steppe2010; @Taneda2008; @Uddling2009) and our synthesis confirms that most of the individual TD and all TTD calibrations underestimate sap flow systematically (Fig. 2.5). Interestingly, however, other studies have found the opposite result (@Cain2009; @Hultine2010; @Lu2002; @Sperling2012; @Sun2012) and simulation models (@Holtta2015; @Wullschleger2011) suggest that it is difficult to state a priori whether TD will over- or underestimate flow, as the measurements obtained are highly dependent on wood properties and on flux conditions. Our results show that, globally, the conditions leading to underestimation are more frequent and support the existence of a proportional bias underlying this systematic underestimation by TD (Fig. 2.3). It must be also noted, however, that Dissipation methods have been tested against a much wider range of flow conditions compared to the rest of the methods (Fig. 2.5, Fig. 2.6).\par

```{r Ch2T4, echo=FALSE,message=FALSE,fig.pos="hbt!",fig.align="center"}
readr::read_delim("data/Ch2/Ch2T4.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)->Ch2T4
library(tidyverse)
library(knitr)
library(kableExtra)

options(knitr.kable.NA = '')
Ch2T4 <- Ch2T4 %>%
  mutate_at(c(11:16),~as.factor(.x)) %>%
  mutate_at(
    c(11:16),
    ~cell_spec(
               .x,
               format = "latex",
               color = factor(.x, c(0, 2, 1),c("#FFFFFF", "#999999", "#BBBBBB")),
               align = "c",
               background = factor(.x, c(0, 2, 1),
                        c("#FFFFFF", "#999999", "#BBBBBB"))
               )
             )
  
knitr::kable(Ch2T4, "latex", booktabs = T,escape = FALSE, align='c', linesep = "", caption.short = "Synthesis of the potential sources of error and use adequacy for each method.", caption = "Synthesis of the potential sources of error and use adequacy for each method. Crosses indicates that the method is sensitive to the respective source of error (updated from Vandegehuchte and Steppe, 2013). Methods are classified according to their use effectiveness under different flow conditions: dark grey, light grey and white indicate highly, partially and no recommended use, respectively. When assessing use adequacy for high/low flows, dark and light gray indicate a Normalized Root Mean Square Error (NRMSE) less than a 22\\% and a 44\\%, respectively, calculated with the NRMSE model (Table 2.2). In Absolute flows use recommendation, dark grey shows methods with both accuracy (Ln-Ratio) and proportional bias (Slope) not significantly different from a perfect calibration. In Relative flows use recommendation, dark grey shows methods with linearity (Slope (ln-ln)) not significantly different from a perfect calibration and with reasonable precision. Potentiality of measuring small stems diameters (< 125mm) is also reported.") %>%
  kableExtra::kable_styling(font_size = 10,latex_options = "hold_position", position = 'center') %>%
  row_spec(0, angle = 90, italic = FALSE) %>%
  # collapse_rows(columns = 1, valign = "middle")%>%
  add_header_above(c(" ", "Potential source of measure error" = 9, "Effectiveness in measuring" = 6)) %>%
  # column_spec(c(1:16)) %>%
  add_footnote("(Low/High: SFD methods: <5 / >80 $\\text{cm}^{3}\\; \\text{cm}^{-2}\\; \\text{h}^{-1}$; SF methods: <260 / >3900 $\\text{cm}^3\\; \\text{h}^{-1}$)",
               escape = FALSE,
               threeparttable = TRUE,
               notation = "symbol"
)
  
```

Calibration parameters of the TD method were originally considered to be universal but subsequent studies have claimed that species-specific calibrations are necessary to obtain correct sap flow measurements (@Fuchs2017; @Lu2004; @Steppe2010). For a set of diffuse-porous species, using a pooled calibration also substantially improved TD (but not HFD) performance compared to measurements obtained with the original calibration (@Fuchs2017). However, our results show that species in general and wood porosity type in particular explain a small or even no proportion of the variability in the calibrations (Table 2.3 and A3). This implies that factors related to the experimental context and, possibly, to intraspecific variability in wood properties (cf. section 2.5.2) may have a large contribution to overall uncertainty. Therefore, our results suggest that calibration parameters for TD or HFD, obtained under different experimental contexts, may not be generalizable to species level, as also suggested by Fuchs et al. [-@Fuchs2017].\par

In addition to Dissipation methods, Pulse methods also suffer proportional bias, probably driven by overestimation at low flows, although this was significant for T-max only (i.e. positive intercepts in linear models fitted to calibration data; Fig. 2.5 and 2.6 and A3). It is well known that the equations of CHP and T-max cannot be solved at sap flows close to 0, and the calibration intercepts observed here (Fig. A3) are consistent with the detection thresholds reported for T-max (~10 $\text{cm}^3\; \text{cm}^{-2}\; \text{h}^{-1}$; @Green2003) and CHP (2-4 $\text{cm}^3\; \text{cm}^{-2}\; \text{h}^{-1}$; @Bleby2004; @Green2003). Our results confirm and generalize a previously reported low-flow detectability problem for T-max (@Green2009; @Green2003; @Vandegehuchte2012a), but we could not confirm it for CHP as described before (@Barrett1995; @Becker1998; @Bleby2004; @Vandegehuchte2012a). Despite overestimation at low flows, the average accuracy of CHP and T-max is good, which implies that low-flow overestimations may be compensated with underestimations at high flows. This is also shown by the lack of linearity observed in both methods (Slope (ln-ln) < 1; Fig. 2.3(b)).\par

Our analysis did not detect the saturation effect for the HR method at high flows that has been reported elsewhere (@Bleby2008; @Green2009; @Steppe2015). This is likely due to the fact that HR calibrations considered here include few observations in the region where this overestimation occurs (> ~45 $\text{cm}^3\; \text{cm}^{-2}\; \text{h}^{-1}$; Figs 2.5 and 2.6). Moreover, the high variability in the calibrations probably precluded detection of the saturation effect (Fig. 2.3 and 2.5) and of the apparent trend of increasing NRMSE with sap flow range for HR (Table 2.3 and Fig. A2). A lack of linearity can also be observed for HFD, consistent with the suggested tendency of this method to underestimate at high flows (@Vandegehuchte2012c).\par

```{r ch2fig5, echo=FALSE,  out.width = '100%', fig.pos="p", fig.align="center", fig.scap= "Relationship between measured and reference sap-flux density (SFD) for different sap flow methods, studies and calibrations.", fig.cap="Relationship between measured and reference sap-flux density (SFD) for different sap flow methods, studies and calibrations. The fits of ln-ln regressions (Eq. 2.4) for each calibration are also depicted. Different colors represent different studies that report results in sap-flux density units. Scales vary across panels to facilitate intra method comparison. The red dotted line indicates the 1:1 relationship."}

knitr::include_graphics(path = "figure/CH2/figure-density.png")
```

Despite the large variability in precision within methods, our results show that calibrations performed with HFD give more precise results than those conducted using the CHP, TD and TTD methods. Although this result should be interpreted with care as it is based on 57 calibrations but only from 3 studies, the higher precision observed with HFD could lie in the second dimension included in the method, which could better capture the effect of anisotropy of the wood structure. This would also be consistent with the fact that SHB, a method that is assumed to integrate sap flow variability within the stem, was the method with the second highest precision on average, albeit precision was very variable for this method (Fig. 2.3(b)).\par

We did not detect differences in accuracy, proportional bias or linearity of the calibrations across calibration materials. However, compared to an ideal calibration, we did find proportional bias and lack of linearity in calibrations performed on whole plants, probably because these calibrations use large scales whose sensitivity and resolution are usually low, potentially affecting low-flow measurements and leading to artefactual overestimation at low flows. Poor linearity may also be due to non-linear changes in belowground hydraulic resistance as the sap flow increases (@Martinez-Vilalta2007). In cut plants, we may have two opposite effects, as cutting could eliminate belowground resistance (favoring flow) but add resistance due to putative embolism formation after cutting. Similarly, the higher precision of calibrations conducted on cut stems relative to those conducted on whole plants (with and without roots), likely reflects that cut stem calibrations are normally conducted in laboratories with precision scales and under controlled conditions that minimize experimental random errors.\par

```{r ch2fig6, echo=FALSE,  out.width = '100%', fig.pos="p", fig.align="center", fig.scap="Relationship between measured and reference sap flow (SF) for different sap flow methods, studies and calibrations.", fig.cap="Relationship between measured and reference sap flow (SF) for different sap flow methods, studies and calibrations. The fits of ln-ln regressions (Eq. 2.4) for each calibration are also depicted. Different color symbols and line types represent different studies. Scales varies across panels to facilitate intra method comparison. Insets are shown in some panels (T-max, SHB, TD) to facilitate visualization when the flow ranges differed markedly among calibrations for the same method. The red dotted line indicates 1:1 relationship."}

knitr::include_graphics(path = "figure/CH2/figure-totalflow.png")
```

###The performance of sap flow calibrations is largely unrelated to species wood traits

Species-specific wood density and wood porosity type explained little variability in overall calibration performance, although we detected some effects of wood density for HFD and TD calibrations. Wood density affected HFD measurements by increasing precision, which could be related to the response time of the sensors. If we assume that maximum sapwood water content is reduced as wood density increases (@Simpson1993), associated changes in thermal diffusivity could lead to a faster sensor response (@Holtta2015), higher correlation between actual and measured flows. Wood density also showed a negative relationship with proportional bias for HFD and TD, a pattern that could be caused by the combined effects of wood density and water content on wood thermal diffusivity (@Vandegehuchte2012c; @Vergeynst2014). The fact that we did not find clear effects of wood density on calibration accuracy and linearity, despite that wood density affects thermal diffusivity and hence heat transport (@Wullschleger2011), could be explained by two reasons. Firstly, we could not use the actual wood density for most of the calibrations, because it was not reported in the corresponding studies, and using species-level averages instead of the wood density of the plant material specifically used on the calibrations may mask the effect of wood density on calibration performance. Secondly, wood density in angiosperms appears to be only weakly correlated to some wood properties that could be important for sap flow calibrations, such as lumen fraction (@Zanne2010).\par

Our global analysis did not show clear and consistent differences in calibration quality between different wood porosity types (Table 2.2) as previously suggested by several studies for both CHP (@Green1988) and TD methods (@Bush2010; @Sun2012). According to heat transport theory, we should expect declining performance from conifer to ring-porous species (i.e. from most homogenous to most heterogeneous wood). For CHP, we found that proportional bias (only marginally) and nonlinearity departed from an ideal calibration for diffuse-porous species, but these patterns did not differ significantly from those observed for conifers. Our results did not clearly support either an inferior performance of TD in ring-porous species compared to diffuse-porous or conifers, as could be expected from the reported underestimation driven by large sap flow gradients along sensor length or by the imperfect probe contact with hydroactive xylem in species with narrow sapwood (@Clearwater1999; but see @Wullschleger2011). Wood porosity effects on sap flow calibrations have been inferred in individual studies from measurements in few species representative of each wood porosity type (@Bush2010; @Sun2012; @Xie2018) and our inability to detect these effects here may be caused by the high variability in experimental context within our dataset. Furthermore, the effect of the different anatomies may be masked by high structural variability within wood porosity types, as for example the variation in latewood to earlywood in conifers (@Fan2018) and we cannot discard that calibration performance could be related to quantitative anatomical traits not assessed in this study (cf. @Xie2018). Although the low variability we observed at the species level suggests that quantitative anatomical traits might not explain much of the variability in sap flow calibrations, we encourage that quantitative wood traits are measured in the same plant material used to calibrate sap flow sensors to better understand the influence of wood properties on the variability of sap flow calibrations.\par

###Implications and recommendations

Our global analysis shows that even when the methods are applied following standard recommendations the quality of individual calibrations can be very low (Fig. 2.3). This result reflects, on one hand, systematic bias in TD and lack of linearity in CHP, two of the most widely used methods (Fig. A1) and, on the other hand, unknown sources of error related to experimental conditions and/or sample characteristics (Table 2.4). In our study, we could not account for all the experimental conditions to evaluate these sources of variability, except for the effect of the calibration material. Examples of factors that may affect calibrations when using the same type of calibration material include sensor design (@Fuchs2017), sensor installation (@Bleby2004; @Lu1998; @Ren2017), variation in calculations of wood thermal properties (@Looker2016), zero flow determination (@Looker2016; @Peters2018) or the mechanism of flow generation in cut stem calibrations (negative vs positive pressures) (@Fuchs2017) (Table 2.4). Previous reports, however, usually focus on only one of the sources of experimental error. Importantly, relevant methodological information that could be used to assess (and account for) these sources of error is frequently not reported (@Peters2018; @Steppe2015). Clearly, further research into the effects of experimental conditions on the quality of different sap flow methods should be a priority, as well as more complete, standardized reporting of experimental conditions, including information on the sources of potential methodological errors listed in Table 2.4.\par

Our results show that calibrations may be needed to obtain correct absolute values of sap flow, even when Pulse methods are used (see also @Fuchs2017; @Steppe2010). However, sap flow calibrations provide a snapshot of the performance of a given sap flow method under relatively stable conditions, which may greatly differ from those experienced by plants in the field. Moreover, our analysis could not address the methodological variability related to more dynamic effects such as errors caused by changes in sapwood water content (@Vergeynst2014), long-term wounding or signal dampening (Maranon-jimenez2018; @Peters2018; @Wiedemann2013). In this sense, more studies should assess calibration applicability to mid- or long-term measurements (e.g., @Oliveras2001), possibly combined with independent estimates of sapwood water content (@Vandegehuchte2012a) and whether calibrations obtained from excised segments are valid for whole-plants.\par

Considering only their performance in calibration tests (i.e. no other logistic or technical issues, such as sensor, datalogging, or power constraints, which will be study-specific) we can provide some general recommendations on the use of sap flow methods (Table 2.4). The most widely used method, TD, appears to be consistently inaccurate, shows proportional bias and generally underestimates sap flow, by 40% on average (if used with its original calibration coefficients). However, it presents good linearity, which implies that this method can be used when sap flow responses to environmental variables and/or treatments are the primary focus of the study (i.e., good estimates of absolute sap flow values are not critical). In comparison, CHP, T-max and HFD all present a certain nonlinearity which may affect the estimation of these environmental responses. At least for CHP and T-max (specially for the latter) this pattern seems to be driven by overestimation at low flows and underestimation at high flows canceling out each other. This implies that both Pulse methods could be suitable for studies interested in absolute values of transpiration. For the HFD method, the nonlinearity could be influencing the estimations of radial sap flow patterns, as these measurements would need to correctly measure both high and low flows simultaneously. We also confirm that the HR method may not be suitable to measure high flows but it is probably the best method for detailed physiological studies involving low flows.\par

##Conclusions

In conclusion, our global assessment contributes towards a proper incorporation of measurement errors in the interpretation of individual case studies and in modelling studies aimed at upscaling sap flow data (@Hatton1995; @Hernandez-Santana2015). Perhaps even more importantly, it paves the way towards improved intercomparison of sap flow datasets obtained with different methods to assess regional or global patterns in plant water use (e.g., the SAPFLUXNET initiative; @Poyatos2016). Although providing explicit correction factors for each method is beyond the scope of this paper, the typical accuracy deviations provided in Table 2.1 can be used as a first order correction when combining sap flow data from different methods (and no additional information on study-specific uncertainty sources is available).\par


---
nocite: | 
  @item1, @item2
...



<!-- % To obtain the results un-comment all the chunks bellow and run it individually -->

<!-- # ```{r FAMILIES, echo=FALSE, include=FALSE} -->
<!-- #  -->
<!-- # #### FAMILIES #### -->
<!-- #  -->
<!-- # source('~/PHD/Chapter1/data preparation 1-1.R') -->
<!-- # subdata1 <- filter(Bar,calibrated=="no",CORRECT_APLICATION == "yes") -->
<!-- #  -->
<!-- # #resume table -->
<!-- #  resume_table <- subdata1 %>% dplyr::select(study,method,specie,porosity,TC,DBH) %>%  -->
<!-- #   group_by(study,method,specie,TC) %>%  -->
<!-- #   dplyr::summarise(porosity = unique(porosity), -->
<!-- #                    DBH = mean(DBH)) -->
<!-- # write.table(resume_table,file='~/PHD/Chapter1/resume_table.csv',dec='.',sep=';') -->
<!-- #  -->
<!-- # #Clearwater and not clearwater aplication on TD calibrations. Is there any difference? -->
<!-- # TD_data <- subdata1 %>% filter(method == 'TD') -->
<!-- # foo_slope <- lmer(slope  ~ Clearwater.correction + TC + (1|study) + (1|specie),data=TD_data) -->
<!-- # foo_log_slope <- lmer(log_slope  ~ Clearwater.correction + TC + (1|study) + (1|specie),data=TD_data) -->
<!-- # foo_log_ratio <- lmer(log_ratio~ Clearwater.correction + TC + (1|study) + (1|specie),data=TD_data) -->
<!-- # foo_z <- lmer(z~ Clearwater.correction + TC + (1|study) + (1|specie),data=TD_data) -->
<!-- #  -->
<!-- # summary(foo_slope) -->
<!-- # summary(foo_log_slope) -->
<!-- # summary(foo_log_ratio) -->
<!-- # summary(foo_z) -->
<!-- #  -->
<!-- # anova(foo_slope) -->
<!-- # anova(foo_log_slope) -->
<!-- # anova(foo_log_ratio) -->
<!-- # anova(foo_z) -->
<!-- #  -->
<!-- #  -->
<!-- # # models -->
<!-- # foo_slope <- lmer(slope  ~ (MF + TC) + (1|study) + (1|specie),data=subdata1) -->
<!-- # foo_log_slope <- lmer(log_slope  ~ (MF + TC) + (1|study) + (1|specie),data=subdata1) -->
<!-- # foo_log_ratio <- lmer(log_ratio~ (MF+TC) + (1|study) + (1|specie),data=subdata1) -->
<!-- # foo_z <- lmer(z~ (MF+TC) + (1|study) + (1|specie),data=subdata1) -->
<!-- # # foo_intercept <- lmer(intercept  ~ MF  + (1|study) + (1|specie),data=subdata1) -->
<!-- #  -->
<!-- # r.squaredGLMM(foo_slope) -->
<!-- # r.squaredGLMM(foo_log_slope) -->
<!-- # r.squaredGLMM(foo_log_ratio) -->
<!-- # r.squaredGLMM(foo_z) -->
<!-- #  -->
<!-- # # lsmeans -->
<!-- # aux1<-emmeans::emmeans(foo_slope,pairwise~MF, adjust="tukey") -->
<!-- # lsslopeMF <- multcomp::cld(aux1$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- # aux2<-emmeans::emmeans(foo_slope,pairwise~TC, adjust="tukey") -->
<!-- # lsslopeTC <- multcomp::cld(aux2$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  -->
<!-- # aux5<-emmeans::emmeans(foo_z,pairwise~MF, adjust="tukey") -->
<!-- # lszMF <- multcomp::cld(aux5$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- # aux6<-emmeans::emmeans(foo_z,pairwise~TC, adjust="tukey") -->
<!-- # lszTC <- multcomp::cld(aux6$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  -->
<!-- # aux7<-emmeans::emmeans(foo_log_slope,pairwise~MF, adjust="tukey") -->
<!-- # lslog_slopeMF <- multcomp::cld(aux7$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- # aux8<-emmeans::emmeans(foo_log_slope,pairwise~TC, adjust="tukey") -->
<!-- # lslog_slopeTC <- multcomp::cld(aux8$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  -->
<!-- # aux9<-emmeans::emmeans(foo_log_ratio,pairwise~MF, adjust="tukey") -->
<!-- # lslog_ratioMF <- multcomp::cld(aux9$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- # aux10<-emmeans::emmeans(foo_log_ratio,pairwise~TC, adjust="tukey") -->
<!-- # lslog_ratioTC <- multcomp::cld(aux10$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  -->
<!-- # # aux11<-emmeans::emmeans(foo_intercept,pairwise~MF, adjust="tukey") -->
<!-- # # lsinterceptMF <- multcomp::cld(aux11$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- # # lsmeans::test(emmeans::emmeans(foo_intercept,~MF), adjust="tukey",null=0) -->
<!-- #  -->
<!-- # emmeans::test(emmeans::emmeans(foo_log_ratio,~MF), adjust="tukey",null=0) -->
<!-- # emmeans::test(emmeans::emmeans(foo_slope,~MF), adjust="tukey",null=1) -->
<!-- # emmeans::test(emmeans::emmeans(foo_log_slope,~MF), adjust="tukey",null=1) -->
<!-- #  -->
<!-- # #accuracy deviation % -->
<!-- # (exp(summary(aux9)$emmeans[,'emmean'])-1)*100 -->
<!-- #  -->
<!-- # #r from z-cor -->
<!-- # tanh(summary(aux5)$emmeans[,'emmean']) -->
<!-- #  -->
<!-- # #n species -->
<!-- # group_by(subdata1,MF)%>%summarize(n_distinct(specie)) -->
<!-- #  -->
<!-- # # resume table -->
<!-- # library(sjPlot) -->
<!-- # library(sjmisc) -->
<!-- # library(sjlabelled) -->
<!-- # tab_model(foo_log_ratio,foo_slope,foo_log_slope,foo_z) -->
<!-- #  -->
<!-- # # plots -->
<!-- # source('~/PHD/Chapter1/methodplot.R') -->
<!-- # p1 <- MFplot(lslog_ratioMF,intercept=0,xlab = 'Method family',ylab = 'Ln-Ratio', ylimits= c(-0.8,0.4)) -->
<!-- # p2 <- TCplot(lslog_ratioTC,intercept=0,xlab = 'Calibration material',ylab = 'Ln-Ratio', ylimits= c(-0.8,0.4)) -->
<!-- #  -->
<!-- # p3 <- MFplot(lsslopeMF,xlab = 'Method family',ylab = 'Slope', ylimits= c(0.4,1.3)) -->
<!-- # p4 <- TCplot(lsslopeTC,xlab = 'Calibration material',ylab = 'Slope', ylimits= c(0.4,1.3)) -->
<!-- #  -->
<!-- # p5 <- MFplot(lslog_slopeMF,xlab = 'Method family',ylab = 'Slope (ln-ln)', ylimits= c(0.6,1.3)) -->
<!-- # p6 <- TCplot(lslog_slopeTC,xlab = 'Calibration material',ylab = 'Slope (ln-ln)', ylimits= c(0.6,1.3)) -->
<!-- #  -->
<!-- # p7 <- MFplot(lszMF,intercept=-9999,xlab = 'Method family',ylab = 'Z-Cor', ylimits= c(1,3.5)) -->
<!-- # p8 <- TCplot(lszTC,intercept=-9999,xlab = 'Calibration material',ylab = 'Z-Cor', ylimits= c(1,3.5)) -->
<!-- #  -->
<!-- # # p9 <- MFplot(lsinterceptMF,intercept=0,xlab = 'Method family',ylab = 'Intercept', ylimits= c(-4,6)) -->
<!-- #  -->
<!-- # source("~/PHD/Chapter1/multiplot.R") -->
<!-- # plotfam <- multiplot(p1,p3,p5,p7,p2,p4,p6,p8,byrow=TRUE,layout=matrix(c(1,2,3,4,5,6,7,8),nrow=4)) -->
<!-- #  -->
<!-- # ``` -->




<!-- # ```{r Methods, echo=FALSE, include=FALSE} -->
<!-- #  -->
<!-- #  #### METHODS #### -->
<!-- #  -->
<!-- #  source('~/PHD/Chapter1/data preparation 1-1.R') -->
<!-- #  # source('data preparation 1-1-density.R') -->
<!-- #  subdata1 <- filter(Bar,calibrated=="no",CORRECT_APLICATION == "yes") -->
<!-- #  subdata1$method <- factor(subdata1$method, levels (subdata1$method) [c(1,5,3,2,4,6,7)]) -->
<!-- #  # subdata1$specie<-stringr::str_trunc(as.character(subdata1$specie),5,side='right',ellipsis = '') -->
<!-- #  # models -->
<!-- #  foo_slope <- lmer(slope  ~ (method + TC) + (1|study) + (1|specie),data=subdata1) -->
<!-- #  foo_log_slope <- lmer(log_slope  ~ (method + TC) + (1|study) + (1|specie),data=subdata1) -->
<!-- #  foo_log_ratio <- lmer(log_ratio~ (method+TC) + (1|study) + (1|specie),data=subdata1) -->
<!-- #  foo_z <- lmer(z~ (method+TC) + (1|study) + (1|specie),data=subdata1) -->
<!-- #  # foo_intercept <- lmer(intercept  ~ method  + (1|study) + (1|specie),data=subdata1) -->
<!-- #  -->
<!-- #  r.squaredGLMM(foo_slope) -->
<!-- #  r.squaredGLMM(foo_log_slope) -->
<!-- #  r.squaredGLMM(foo_log_ratio) -->
<!-- #  r.squaredGLMM(foo_z) -->
<!-- #  -->
<!-- #  # emmeans -->
<!-- #  aux1<-emmeans::emmeans(foo_slope,pairwise~method, adjust="tukey") -->
<!-- #  lsslopemethod <- multcomp::cld(aux1$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  aux2<-emmeans::emmeans(foo_slope,pairwise~TC, adjust="tukey") -->
<!-- #  lsslopeTC <- multcomp::cld(aux2$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  -->
<!-- #  aux5<-emmeans::emmeans(foo_z,pairwise~method, adjust="tukey") -->
<!-- #  lszmethod <- multcomp::cld(aux5$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  aux6<-emmeans::emmeans(foo_z,pairwise~TC, adjust="tukey") -->
<!-- #  lszTC <- multcomp::cld(aux6$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  -->
<!-- #  aux7<-emmeans::emmeans(foo_log_slope,pairwise~method, adjust="tukey") -->
<!-- #  lslog_slopemethod <- multcomp::cld(aux7$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  aux8<-emmeans::emmeans(foo_log_slope,pairwise~TC, adjust="tukey") -->
<!-- #  lslog_slopeTC <- multcomp::cld(aux8$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  -->
<!-- #  aux9<-emmeans::emmeans(foo_log_ratio,pairwise~method, adjust="tukey") -->
<!-- #  lslog_ratiomethod <- multcomp::cld(aux9$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  aux10<-emmeans::emmeans(foo_log_ratio,pairwise~TC, adjust="tukey") -->
<!-- #  lslog_ratioTC <- multcomp::cld(aux10$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  -->
<!-- #  # aux11<-emmeans::emmeans(foo_intercept,pairwise~method, adjust="tukey") -->
<!-- #  # lsinterceptmethod <- multcomp::cld(aux11,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #  # lsmeans::test(emmeans::emmeans(foo_intercept,~method), adjust="tukey",null=0) -->
<!-- #  -->
<!-- #  -->
<!-- #  emmeans::test(emmeans::emmeans(foo_log_ratio,~method), adjust="tukey",null=0) -->
<!-- #  emmeans::test(emmeans::emmeans(foo_slope,~method), adjust="tukey",null=1) -->
<!-- #  emmeans::test(emmeans::emmeans(foo_log_slope,~method), adjust="tukey",null=1) -->
<!-- #  -->
<!-- #  #accuracy deviation % -->
<!-- #  (exp(summary(aux9)$emmeans[,'emmean'])-1)*100 -->
<!-- #  -->
<!-- #  #r from z-cor -->
<!-- #  tanh(summary(aux5)$emmeans[,'emmean']) -->
<!-- #  -->
<!-- #  #n species -->
<!-- #  group_by(subdata1,method)%>%summarize(n_distinct(specie)) -->
<!-- #  -->
<!-- #  # resume table -->
<!-- #  tab_model(foo_log_ratio,foo_slope,foo_log_slope,foo_z) -->
<!-- #  -->
<!-- #  # plots -->
<!-- #  source('~/PHD/Chapter1/methodplot.R') -->
<!-- #  p1 <- methodplot(lslog_ratiomethod,intercept=0,xlab = 'Method family',ylab = 'Ln-Ratio', ylimits= c(-1,0.6)) -->
<!-- #  p2 <- TCplot(lslog_ratioTC,intercept=0,xlab = 'Calibration material',ylab = 'Ln-Ratio', ylimits= c(-1,0.6)) -->
<!-- #  -->
<!-- #  p3 <- methodplot(lsslopemethod,xlab = 'Method family',ylab = 'Slope', ylimits= c(0.2,1.3)) -->
<!-- #  p4 <- TCplot(lsslopeTC,xlab = 'Calibration material',ylab = 'Slope', ylimits= c(0.2,1.3)) -->
<!-- #  -->
<!-- # # p5 <- methodplot(lslog_slopemethod,xlab = 'Method family',ylab = 'Slope (ln-ln)', ylimits= c(0.3,1.3)) -->
<!-- #  p6 <- TCplot(lslog_slopeTC,xlab = 'Calibration material',ylab = 'Slope (ln-ln)', ylimits= c(0.3,1.3)) -->
<!-- #  -->
<!-- #  p7 <- methodplot(lszmethod,intercept=-9999,xlab = 'Method family',ylab = 'Z-Cor', ylimits= c(0.6,3.5)) -->
<!-- #  p8 <- TCplot(lszTC,intercept=-9999,xlab = 'Calibration material',ylab = 'Z-Cor', ylimits= c(0.6,3.5)) -->
<!-- #  -->
<!-- #  # p9 <- methodplot(lsinterceptmethod,intercept=0,xlab = 'Method family',ylab = 'Intercept', ylimits= c(-5,17)) -->
<!-- #  -->
<!-- #  source("~/PHD/Chapter1/multiplot.R") -->
<!-- #  plotfam <- multiplot(p1,p3,p5,p7,p2,p4,p6,p8,byrow=TRUE,layout=matrix(c(1,2,3,4,5,6,7,8),nrow=4)) -->
<!-- #  -->
<!-- # ``` -->


<!-- # ``` {r resumecorrectaplication, echo = FALSE} -->
<!-- # #### Resume studies correct aplication by methods #### -->
<!-- # xxx <- subdata1 %>% group_by(study,CORRECT_APLICATION,method) %>% summarise()  -->
<!-- #     # summarise_all(funs(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) -->
<!-- # ```   -->

<!-- # ```{r density, echo=FALSE, include=FALSE}    -->
<!-- # #### DENSITY #### -->
<!-- #     source('~/PHD/Chapter1/data preparation 1-1.R') -->
<!-- #     subdata_dens <- filter(Bar,calibrated=="no",CORRECT_APLICATION == "yes") -->
<!-- #      -->
<!-- #     foo_slope <- lmer(slope  ~ (method*density + TC) + (1|study) + (1|specie),data=subdata_dens) -->
<!-- #     foo_log_slope <- lmer(log_slope  ~ (method*density  + TC) + (1|study) + (1|specie),data=subdata_dens) -->
<!-- #     foo_log_ratio <- lmer(log_ratio~ (method*density + TC) + (1|study) + (1|specie),data=subdata_dens) -->
<!-- #     foo_z <- lmer(z~ (method*density + TC) + (1|study) + (1|specie),data=subdata_dens) -->
<!-- #  -->
<!-- #     anova(foo_slope) -->
<!-- #     anova(foo_log_slope) -->
<!-- #     anova(foo_log_ratio) -->
<!-- #     anova(foo_z) -->
<!-- #      -->
<!-- #      -->
<!-- #     tab_model(foo_log_ratio,foo_slope,foo_log_slope,foo_z) -->
<!-- #      -->
<!-- # #lsmean log_ratio -->
<!-- #     aux1_dens<-emmeans::emtrends(foo_log_ratio, ~method, var="density") -->
<!-- #     lsratiomethod <- multcomp::cld(aux1_dens,alpha=0.05,Letters=letters,adjust="none") -->
<!-- #     emmeans::test(emmeans::emtrends(foo_log_ratio,~method,var='density'),null=0) -->
<!-- # #lsmean slope -->
<!-- #     aux3_dens<- emmeans::emtrends(foo_slope, ~method, var="density") -->
<!-- #     lsslopemethod <- multcomp::cld(aux3_dens,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #     emmeans::test(emmeans::emtrends(foo_slope,~method,var='density'),null=0) -->
<!-- # #lsmean log_slope    -->
<!-- #     aux2_dens<- emmeans::emtrends(foo_log_slope, ~method, var="density") -->
<!-- #     lsslopemethod <- multcomp::cld(aux2_dens,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #     emmeans::test(emmeans::emtrends(foo_log_slope,~method,var='density'),null=0) -->
<!-- # #lsmean z     -->
<!-- #     aux4_dens<-(emmeans::emtrends(foo_z, ~method, var="density")) -->
<!-- #     lszmethod <- multcomp::cld(aux4_dens,alpha=0.05,Letters=letters,adjust="tukey")  -->
<!-- #     emmeans::test(emmeans::emtrends(foo_z,~method,var='density'),null=0) -->
<!-- #  -->
<!-- # # density plots     -->
<!-- #     eff_df1 <- data.frame(effects::Effect(c('density','method'),foo_log_ratio)) -->
<!-- #     p1 <- ggplot()+ -->
<!-- #       geom_line(data=eff_df1,aes(density,fit,color=method))+ -->
<!-- #       geom_jitter(data=subdata_dens,aes(density,log_ratio,color=method))+ -->
<!-- #       theme_bw()+ -->
<!-- #       xlab ( expression(density)) + -->
<!-- #       ylab ( expression(Ln-Ratio)) + -->
<!-- #       labs(color="",fill="")+ -->
<!-- #       theme(legend.position="none") -->
<!-- #      -->
<!-- #      -->
<!-- #     eff_df2 <- data.frame(effects::Effect(c('density','method'),foo_slope)) -->
<!-- #     p2 <- ggplot()+ -->
<!-- #       geom_line(data=eff_df2,aes(density,fit,color=method))+ -->
<!-- #       geom_jitter(data=subdata_dens,aes(density,slope,color=method))+ -->
<!-- #       theme_bw()+ -->
<!-- #       xlab ( expression(density)) + -->
<!-- #       ylab ( expression(Slope)) + -->
<!-- #       labs(color="",fill="")+ -->
<!-- #       theme(legend.position="none")+ -->
<!-- #       scale_y_continuous(limits = c(-0.1, 2.1)) -->
<!-- #      -->
<!-- #     eff_df3 <- data.frame(effects::Effect(c('density','method'),foo_log_slope)) -->
<!-- #     p3 <- ggplot()+ -->
<!-- #       geom_line(data=eff_df3,aes(density,fit,color=method))+ -->
<!-- #       geom_jitter(data=subdata_dens,aes(density,log_slope,color=method))+ -->
<!-- #       theme_bw()+ -->
<!-- #       xlab ( "density") + -->
<!-- #       ylab ( "Slope (ln-ln)" ) + -->
<!-- #       labs(color="",fill="")+ -->
<!-- #       theme(legend.position="none")+ -->
<!-- #       scale_y_continuous(limits = c(-0.1, 2.1)) -->
<!-- #  -->
<!-- #  -->
<!-- #     eff_df4 <- data.frame(effects::Effect(c('density','method'),foo_z)) -->
<!-- #     p4 <- ggplot()+ -->
<!-- #       geom_line(data=eff_df4,aes(x=density,y=fit,color=method))+ -->
<!-- #       geom_jitter(data=subdata_dens,aes(density,z,color=method))+ -->
<!-- #       theme_bw()+ -->
<!-- #       xlab ( expression(density)) + -->
<!-- #       ylab ( expression(Z-correlation)) + -->
<!-- #       labs(color='',fill="")+ -->
<!-- #       theme(legend.position="none") -->
<!-- #  -->
<!-- #      -->
<!-- #     source("~/PHD/Chapter1/multiplot.R") -->
<!-- #     multiplot(p1,p2,p3,p4, cols=1) -->
<!-- #  -->
<!-- # ```     -->
 

<!-- # ```{r porosity, echo=FALSE, include=FALSE}       -->
<!-- #  -->
<!-- # #### POROSITY ####    -->
<!-- #     source('~/PHD/Chapter1/data preparation 1-1.R') -->
<!-- #     subdataTD <- filter(Bar,calibrated=="no",CORRECT_APLICATION == "yes",method == "TD",porosity!="Monocot") -->
<!-- #     subdataCHP <- filter(Bar,calibrated=="no",CORRECT_APLICATION == "yes",method == "CHP",porosity!="Ring porous") -->
<!-- #     # models TD -->
<!-- #     foo_slope_TD <- lmer(slope  ~ (porosity + TC) + (1|study) + (1|specie),data=subdataTD) -->
<!-- #     foo_log_slope_TD <- lmer(log_slope  ~ (porosity + TC) + (1|study) + (1|specie),data=subdataTD) -->
<!-- #     foo_log_ratio_TD <- lmer(log_ratio~ (porosity + TC) + (1|study) + (1|specie),data=subdataTD) -->
<!-- #     foo_z_TD <- lmer(z~ (porosity + TC) + (1|study) + (1|specie),data=subdataTD) -->
<!-- #      -->
<!-- #     # models CHP -->
<!-- #     foo_slope_CHP <- lmer(slope  ~ (porosity + TC) + (1|study) + (1|specie),data=subdataCHP) -->
<!-- #     foo_log_slope_CHP <- lmer(log_slope  ~ (porosity + TC) + (1|study) + (1|specie),data=subdataCHP) -->
<!-- #     foo_log_ratio_CHP <- lmer(log_ratio~ (porosity + TC) + (1|study) + (1|specie),data=subdataCHP) -->
<!-- #     foo_z_CHP <- lmer(z~ (porosity + TC) + (1|study) + (1|specie),data=subdataCHP) -->
<!-- #      -->
<!-- #     # lsmeans TD -->
<!-- #     aux1<-emmeans::emmeans(foo_log_ratio_TD,pairwise~porosity, adjust="tukey") -->
<!-- #     lslog_ratiomethod_TD <- multcomp::cld(aux1$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #     emmeans::test(emmeans::emmeans(foo_log_ratio_TD,~porosity, adjust="tukey"),null=0) -->
<!-- #      -->
<!-- #     aux2<-emmeans::emmeans(foo_slope_TD,pairwise~porosity, adjust="tukey") -->
<!-- #     lsslopemethod_TD <- multcomp::cld(aux2$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #     emmeans::test(emmeans::emmeans(foo_slope_TD,~porosity, adjust="tukey"),null=1) -->
<!-- #      -->
<!-- #     aux3<-emmeans::emmeans(foo_log_slope_TD,pairwise~porosity, adjust="tukey") -->
<!-- #     lslog_slopemethod_TD <- multcomp::cld(aux3$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #     emmeans::test(emmeans::emmeans(foo_log_slope_TD,~porosity, adjust="tukey"),null=1) -->
<!-- #  -->
<!-- #     aux4<-emmeans::emmeans(foo_z_TD,pairwise~porosity, adjust="tukey") -->
<!-- #     lszmethod_TD <- multcomp::cld(aux4$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #      -->
<!-- #     #n species -->
<!-- #     group_by(subdataTD,porosity,method)%>%summarize(n()) -->
<!-- #  -->
<!-- #  -->
<!-- #     # lsmeans CHP -->
<!-- #     aux5<-emmeans::emmeans(foo_log_ratio_CHP,pairwise~porosity, adjust="tukey") -->
<!-- #     lslog_ratiomethod_CHP <- multcomp::cld(aux5$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #     emmeans::test(emmeans::emmeans(foo_log_ratio_CHP,~porosity, adjust="tukey"),null=0) -->
<!-- #      -->
<!-- #     aux6<-emmeans::emmeans(foo_slope_CHP,pairwise~porosity, adjust="tukey") -->
<!-- #     lsslopemethod_CHP <- multcomp::cld(aux6$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #     emmeans::test(emmeans::emmeans(foo_slope_CHP,~porosity, adjust="tukey"),null=1) -->
<!-- #      -->
<!-- #     aux7<-emmeans::emmeans(foo_log_slope_CHP,pairwise~porosity, adjust="tukey") -->
<!-- #     lslog_slopemethod_CHP <- multcomp::cld(aux7$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #     emmeans::test(emmeans::emmeans(foo_log_slope_CHP,~porosity, adjust="tukey"),null=1) -->
<!-- #      -->
<!-- #     aux8<-emmeans::emmeans(foo_z_CHP,pairwise~porosity, adjust="tukey") -->
<!-- #     lszmethod_CHP <- multcomp::cld(aux8$emmeans,alpha=0.05,Letters=letters,adjust="tukey") -->
<!-- #      -->
<!-- #     group_by(subdataCHP,porosity,method)%>%summarize(n()) -->
<!-- #      -->
<!-- #     # resume table -->
<!-- #     tab_model(foo_log_ratio_TD,foo_slope_TD,foo_log_slope_TD,foo_z_TD) -->
<!-- #      -->
<!-- #     tab_model(foo_log_ratio_CHP,foo_slope_CHP,foo_log_slope_CHP,foo_z_CHP) -->
<!-- #      -->
<!-- # ```     -->


<!-- # ```{r RMSE,echo=FALSE, include=FALSE} -->
<!-- # #### RMSE #### -->
<!-- # source('~/PHD/Chapter1/data preparation 1-1-density.R') -->
<!-- # # source('~/PHD/Chapter1/data preparation 1-1-totalflow.R') -->
<!-- # # source('~/PHD/Chapter1/data preparation 1-1.R') -->
<!-- # subdata <- filter(Bar,calibrated == "no",CORRECT_APLICATION == "yes") -->
<!-- # subdata$method <- factor(subdata$method, levels (subdata$method) [c(1,5,3,2,4,6,7)]) -->
<!-- #  -->
<!-- #  -->
<!-- # foo_rmse <- lmer(NRMSE ~  range_mean  * method    + (1|study) + (1|specie),data=subdata) -->
<!-- #  -->
<!-- #  -->
<!-- # # #SFD -->
<!-- # # foo_rmse <- lmer(rmse ~  range_mean * method    + (1|study) + (1|specie),data=subdata) -->
<!-- # # #SF -->
<!-- # # foo_rmse <- lmer(rmse ~  range_mean * method   + (1|study) + (1|specie),data=subdata) -->
<!-- #  -->
<!-- # summary(foo_rmse) -->
<!-- # anova(foo_rmse) -->
<!-- #  -->
<!-- # plot(effects::Effect(focal.predictors = c("range_mean","method"), mod = foo_rmse, -->
<!-- #             xlevels=list(method=seq(0, 100, 1), median=0:100))) -->
<!-- # plot(effects::Effect(focal.predictors = c("range_mean","method"), mod = foo_rmse, -->
<!-- #                      xlevels=list(method=seq(0, 100, 1), range_mean=0:100))) -->
<!-- #  -->
<!-- # emmeans::test(emmeans::emmeans(foo_rmse,~range_mean * method, adjust="tukey",at = list(range_mean = 0)),null=0) -->
<!-- # emmeans::test(emmeans::lstrends(foo_rmse,~method,var='range_mean'),null=1) -->
<!-- # # lsmeans::test(lsmeans::lstrends(foo_rmse,~method,var='I(range_mean^2)'),null=1) -->
<!-- # emmeans::test(emmeans::emmeans(foo_rmse,~range_mean * method, adjust="tukey",at = list(range_mean = 25)),null=0) -->
<!-- # emmeans::test(emmeans::emmeans(foo_rmse,~range_mean*method , adjust="tukey",at = list(range_mean = 1300)),null=0) -->
<!-- #  -->
<!-- # ``` -->
